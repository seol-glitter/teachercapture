<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>문제 화면</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif; padding:16px; line-height:1.5}
  select, input, button{padding:10px; border:1px solid #ddd; border-radius:10px}
  button{background:#111; color:#fff; font-weight:700}
  .note{font-size:12px; opacity:.75}
</style>

<body>
  <h2 id="title">문제</h2>
  <div id="info" class="note">세션 확인 중…</div>

  <div id="chooseBox" style="display:none; margin:12px 0">
    <div>내 이름을 골라요</div>
    <select id="childSelect"></select>
    <button id="chooseBtn" style="margin-left:8px">선택 완료</button>
  </div>

  <div id="readyBox" style="display:none; margin-top:12px">
    <div class="note" id="selInfo"></div>
    <button id="start">촬영/저장 시작</button>
  </div>

<script>
// ★ Apps Script /exec 주소(넣어둠)
const SESSION_API = "https://script.google.com/macros/s/AKfycbwxQdrD9d358f1OWhIzC54f4pnCArgmNqx4LQqBpsYDlUnRAJU_A5hqdVZnnO5tIhHcOA/exec";

// URL 파라미터
const qp         = new URLSearchParams(location.search);
const SID        = qp.get('sid');
const PROBLEM_ID = qp.get('problem') || 'unknown_problem';
document.getElementById('title').textContent = `문제 · ${PROBLEM_ID}`;

const info       = document.getElementById('info');
const chooseBox  = document.getElementById('chooseBox');
const childSel   = document.getElementById('childSelect');
const chooseBtn  = document.getElementById('chooseBtn');
const readyBox   = document.getElementById('readyBox');
const selInfo    = document.getElementById('selInfo');

let CLASS_ID = '', CHILD = '', ROSTER = [];

async function resolve(){
  if (!SID){ info.textContent = '세션이 없습니다. 홈에서 다시 시작해 주세요.'; return; }
  try{
    const url = SESSION_API + '?action=resolve&sid=' + encodeURIComponent(SID);
    const j   = await fetch(url).then(r=>r.json());
    if (!j.ok){ info.textContent = '세션 만료/오류: 홈에서 세션을 다시 만드세요.'; return; }

    CLASS_ID = j.classId || 'unknown_class';
    ROSTER   = Array.isArray(j.roster) ? j.roster : [];
    CHILD    = (j.child || '').trim();

    // 이름 선택 UI
    if (ROSTER.length > 0){
      childSel.innerHTML = ROSTER.map(n=>`<option value="${n}">${n}</option>`).join('');
      // child 초기값이 로스터에 있으면 선택
      if (CHILD && ROSTER.includes(CHILD)) childSel.value = CHILD;
      chooseBox.style.display = 'block';
      info.textContent = `반: ${CLASS_ID} / 문제: ${PROBLEM_ID} — 이름을 선택해 주세요.`;
    } else {
      // 로스터가 없으면 기존 child(또는 빈값) 사용
      selInfo.textContent = `반: ${CLASS_ID} / 아동: ${CHILD || '(미입력)'} / 문제: ${PROBLEM_ID}`;
      readyBox.style.display = 'block';
      info.textContent = '';
    }
  }catch(e){
    info.textContent = '네트워크 오류: ' + e;
  }
}
resolve();

chooseBtn.onclick = ()=>{
  CHILD = childSel.value || '';
  selInfo.textContent = `반: ${CLASS_ID} / 아동: ${CHILD || '(미입력)'} / 문제: ${PROBLEM_ID}`;
  chooseBox.style.display = 'none';
  readyBox.style.display  = 'block';
};

// ★ 여기서부터 "촬영/업로드(STT 등)" 기존 로직을 연결하세요.
//   업로드 메타데이터에 classId=CLASS_ID, child=CHILD, problemId=PROBLEM_ID 포함.
document.getElementById('start').onclick = ()=>{
  alert(`[샘플] 촬영/업로드 시작\n반=${CLASS_ID}\n아동=${CHILD}\n문제=${PROBLEM_ID}`);
  // 예) Firebase Storage 경로:
  // teachers/{uid}/classes/{CLASS_ID}/{PROBLEM_ID}/photos/{timestamp}.jpg
};
</script>
</body>
