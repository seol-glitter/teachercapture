<!doctype html>
<html lang="ko">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ìº¡ì³ Â· ì•ˆì „ ì—´ì‡ </title>
<style>
:root{ --bg-top:#cfe9fb; --bg-bottom:#ffffff; --ink:#0b2a4a; --line:#d7e7f5; }
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;color:var(--ink);background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom))}
.wrap{max-width:780px;margin:0 auto;padding:16px 14px 28px}
.closeBtn{position:fixed;right:14px;top:14px;z-index:10;padding:10px 14px;border:0;border-radius:999px;font-weight:900;background:#0d2744;color:#fff;box-shadow:0 10px 24px rgba(13,39,68,.25);cursor:pointer}
.splash{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100dvh - 60px);text-align:center;gap:16px}
.key{width:min(420px,38vw);height:auto;filter:drop-shadow(0 12px 30px rgba(0,0,0,.18))}
h2.big{margin:6px 0 0;font-size:clamp(48px,10vw,120px);line-height:1.04;letter-spacing:-.02em;text-shadow:0 2px 12px rgba(255,255,255,.35)}
.note{font-size:12px;opacity:.8}
.video{width:100%;aspect-ratio:3/4;background:#000;border-radius:14px;overflow:hidden;border:1px solid var(--line);box-shadow:0 10px 26px rgba(13,39,68,.15)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
.btn{flex:1;padding:12px 14px;border:0;border-radius:12px;font-weight:900;cursor:pointer;background:#274766;color:#fff;box-shadow:0 6px 16px rgba(15,47,87,.18)}
.btn.secondary{background:#6b7b8c}
.hidden{display:none}
</style>
<body>
<button class="closeBtn" id="btnClose">ë‹«ê¸° âœ•</button>
<div class="wrap">

  <!-- ìŠ¤í”Œë˜ì‹œ(í•­ìƒ ë¨¼ì € ë…¸ì¶œ) -->
  <div class="splash" id="splash">
    <img id="keyImg" class="key" alt="ì•ˆì „ ì—´ì‡ ">
    <h2 class="big">ì„±ê³µì…ë‹ˆë‹¤!</h2>
  </div>

  <!-- ì´¬ì˜/ì—…ë¡œë“œ UI(ê°€ì… ê¸°ê¸°ë§Œ ì „í™˜) -->
  <video id="v" class="video hidden" autoplay playsinline muted></video>
  <div class="row hidden" id="btnRow">
    <button id="snap" class="btn">ì´¬ì˜í•˜ê¸°</button>
    <button id="retake" class="btn secondary">ë‹¤ì‹œ ì°ê¸°</button>
    <button id="upload" class="btn">ì—…ë¡œë“œ</button>
  </div>
  <div class="row hidden" id="optRow">
    <label class="note"><input type="checkbox" id="localMatch" checked> ê¸°ê¸° ë‚´ ìë™ë¶„ë¥˜ ë„ì›€(ì €ì¥ X)</label>
  </div>
  <div class="note" id="msg" style="margin-top:6px"></div>

  <!-- ì—…ë¡œë“œ í¼ -->
  <form id="upForm" method="post" target="hidden_iframe" enctype="multipart/form-data" onsubmit="return onUpload()" class="hidden">
    <input type="hidden" name="action"  value="uploadSuccess">
    <input type="hidden" name="key"     id="f_key">
    <input type="hidden" name="problem" id="f_problem">
    <input type="hidden" name="child"   id="f_child">
    <input type="hidden" name="ts"      id="f_ts">
    <input type="hidden" name="embed_csv" id="f_embed">
    <input type="file"   name="file"    id="f_file" accept="image/*" capture="user">
  </form>
  <iframe name="hidden_iframe" style="display:none"></iframe>
</div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<script>
// â˜… Apps Script EXEC (A/B)
const EXEC_B="https://script.google.com/macros/s/AKfycbzNUWjOhh3V-Cu2WYkl6voDKoAHFKjOl_OQbKH6rQYj6o8K06YoQmc0D7Q6WMJJ-Foz/exec";
const EXEC_A="https://script.google.com/macros/s/AKfycby4camh7UDnlV4ElL3eJPUUWvslSAtfyssAQBRfizcY9D1MRJK9r_O0ZYDnQvKryalG/exec";
// ğŸ”‘ ì—´ì‡  ì´ë¯¸ì§€(ê¹ƒí—ˆë¸Œ Pages ë“± ì ˆëŒ€/ìƒëŒ€ê²½ë¡œ ì‚¬ìš©)
const KEY_IMG_URL="<<ì˜ˆ: ./images/fire-key.png ë˜ëŠ” https://seol-glitter.github.io/parents/images/fire-key.png>>";

const qs=new URLSearchParams(location.search);
const problem=(qs.get('problem')||'').trim();
const tk=((qs.get('tk')||localStorage.getItem('tk')||'').trim());
const MODE=((qs.get('mode')||localStorage.getItem('mode')||'b').trim().toLowerCase()==='a')?'a':'b';
const EXEC=MODE==='a'?EXEC_A:EXEC_B;

// ìŠ¤í”Œë˜ì‹œ ì´ë¯¸ì§€
const keyEl=document.getElementById('keyImg'); keyEl.src = KEY_IMG_URL;

// ë‹«ê¸° ë²„íŠ¼
document.getElementById('btnClose').onclick=()=>{ window.close(); history.back(); };

// tk && problemì´ë©´ 1.4ì´ˆ ë’¤ ì´¬ì˜ ë‹¨ê³„ë¡œ ì „í™˜(ì†ë‹˜ëª¨ë“œë©´ ìŠ¤í”Œë˜ì‹œë§Œ)
if(tk && problem){ setTimeout(startCameraFlow, 1400); }

const v=$('v'), snap=$('snap'), retake=$('retake'), upload=$('upload'), msg=$('msg'), localMatch=$('localMatch');
const btnRow=$('btnRow'), optRow=$('optRow'), splash=$('splash'), upForm=$('upForm');
let stream=null, lastBlob=null, lastEmbed=null;
function $(id){return document.getElementById(id)}
function showCaptureUI(show){
  if(show){ v.classList.remove('hidden'); btnRow.classList.remove('hidden'); optRow.classList.remove('hidden'); upForm.classList.remove('hidden'); splash.classList.add('hidden'); }
}
async function startCameraFlow(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false});
    v.srcObject=stream;
    showCaptureUI(true);
    snap.style.display='inline-block'; retake.style.display='none'; upload.style.display='none';
  }catch(e){ msg.textContent='ì¹´ë©”ë¼ ê¶Œí•œ í•„ìš”: '+e.message; }
}

snap.onclick=async ()=>{
  try{
    const c=document.createElement('canvas'); const ctx=c.getContext('2d');
    if('ImageCapture' in window && stream?.getVideoTracks?.()[0]){
      const cap=new ImageCapture(stream.getVideoTracks()[0]); const bitmap=await cap.grabFrame();
      c.width=bitmap.width; c.height=bitmap.height; ctx.drawImage(bitmap,0,0);
    }else{
      c.width = v.videoWidth || 720; c.height = v.videoHeight || Math.round(c.width*4/3);
      ctx.drawImage(v,0,0,c.width,c.height);
    }
    const blob = await new Promise(res=>c.toBlob(b=>res(b),'image/jpeg',0.9));
    lastBlob=blob; lastEmbed=null;
    $('f_file').files = await fileListFromBlob(lastBlob,'capture.jpg');
    $('f_ts').value = Date.now();

    // A/B: ì„ë² ë”© ê³„ì‚°(ë¡œì»¬)
    if((MODE==='a') || (MODE==='b' && localMatch.checked)){
      try{
        await ensureModels();
        const det=await faceapi.detectSingleFace(c,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        if(det && det.descriptor){ lastEmbed=det.descriptor; }
      }catch(_){}
    }

    snap.style.display='none'; retake.style.display='inline-block'; upload.style.display='inline-block';
    msg.textContent='ì´¬ì˜ ì™„ë£Œ. ì—…ë¡œë“œë¥¼ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”.';
  }catch(e){ msg.textContent='ì´¬ì˜ ì˜¤ë¥˜: '+e.message; }
};
retake.onclick=()=>{ lastBlob=null; lastEmbed=null; snap.style.display='inline-block'; retake.style.display='none'; upload.style.display='none'; msg.textContent=''; };
upload.onclick=()=>{
  let childAlias='';
  if(MODE==='b' && localMatch.checked && lastEmbed){ childAlias=localMatchOrCreateAlias(lastEmbed); }
  $('f_key').value     = tk;
  $('f_problem').value = problem;
  $('f_child').value   = childAlias;
  $('f_embed').value   = (MODE==='a' && lastEmbed) ? Array.from(lastEmbed).join(',') : '';
  upForm.action        = (MODE==='a'?EXEC_A:EXEC_B);
  upForm.submit();
  msg.textContent='ì—…ë¡œë“œ ì¤‘â€¦ ì™„ë£Œ í›„ ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”.';
  setTimeout(()=>{ retake.click(); }, 1200);
};

function onUpload(){ return true; }
async function fileListFromBlob(blob, filename){
  const dt=new DataTransfer(); dt.items.add(new File([blob], filename, {type:blob.type})); return dt.files;
}

// face-api.js (Aëª¨ë“œ/ë¡œì»¬ë³´ì¡°ìš©)
let modelsReady=false;
async function ensureModels(){
  if(modelsReady) return;
  const base='https://cdn.jsdelivr.net/npm/face-api.js/weights/';
  await faceapi.nets.tinyFaceDetector.loadFromUri(base);
  await faceapi.nets.faceLandmark68Net.loadFromUri(base);
  await faceapi.nets.faceRecognitionNet.loadFromUri(base);
  modelsReady=true;
}
function cosine(a,b){let dot=0,na=0,nb=0;for(let i=0;i<a.length;i++){dot+=a[i]*b[i];na+=a[i]*a[i];nb+=b[i]*b[i]}return dot/(Math.sqrt(na)*Math.sqrt(nb)+1e-9)}
function getLocalDB(){ try{return JSON.parse(localStorage.getItem('faceDB')||'{}')}catch(_){return{}} }
function setLocalDB(db){ localStorage.setItem('faceDB', JSON.stringify(db)) }
function localMatchOrCreateAlias(embed){
  let db=getLocalDB(); let bestId='',bestScore=-1;
  Object.keys(db).forEach(id=>{const c=db[id]; const s=cosine(embed,new Float32Array(c.vec)); if(s>bestScore){bestScore=s;bestId=id;}});
  if(bestScore>=0.83){
    const c=db[bestId], alpha=0.85, v=new Float32Array(c.vec);
    for(let i=0;i<embed.length;i++) v[i]=alpha*v[i]+(1-alpha)*embed[i];
    db[bestId]={vec:Array.from(v),n:(c.n||1)+1}; setLocalDB(db); return bestId;
  }
  const alias='ì•„ì´'+Math.random().toString(36).slice(2,6);
  db[alias]={vec:Array.from(embed),n:1}; setLocalDB(db); return alias;
}
</script>
</body>
</html>
