<!doctype html>
<html lang="ko">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>캡쳐 · 불의 마법을 푸는 안전 열쇠</title>
<style>
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;background:#000;color:#fff}
.wrap{max-width:720px;margin:0 auto;padding:12px}
h1{font-size:18px;margin:6px 0 10px}
.video{width:100%;aspect-ratio:3/4;background:#111;border-radius:12px;overflow:hidden}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
.btn{flex:1;padding:12px 14px;border:0;border-radius:12px;background:#22c55e;color:#083016;font-weight:900;cursor:pointer}
.btn.secondary{background:#334155;color:#fff}
.note{font-size:12px;opacity:.9}
.center{display:flex;justify-content:center}
</style>
<body>
<div class="wrap">
  <h1>문제 촬영</h1>
  <div class="note" id="meta"></div>
  <video id="v" class="video" autoplay playsinline muted></video>
  <div class="row">
    <button id="snap" class="btn">촬영하기</button>
    <button id="retake" class="btn secondary" style="display:none">다시 찍기</button>
    <button id="upload" class="btn" style="display:none">업로드</button>
  </div>
  <div class="row"><label><input type="checkbox" id="localMatch" checked> 기기 내 자동분류 도움(저장 X)</label></div>
  <div class="note" id="msg" style="margin-top:6px"></div>

  <form id="upForm" method="post" target="hidden_iframe" enctype="multipart/form-data" onsubmit="return onUpload()"
        style="display:none">
    <input type="hidden" name="action"  value="uploadSuccess">
    <input type="hidden" name="key"     id="f_key">
    <input type="hidden" name="problem" id="f_problem">
    <input type="hidden" name="child"   id="f_child">
    <input type="hidden" name="ts"      id="f_ts">
    <input type="hidden" name="embed_b64" id="f_embed">
    <input type="file"   name="file"    id="f_file" accept="image/*" capture="user">
  </form>
  <iframe name="hidden_iframe" style="display:none"></iframe>
</div>

<!-- (선택) 임베딩 추출 라이브러리: A모드 필수, B모드에선 켜두면 로컬 매칭 가능 -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<script>
const EXEC_B = "https://script.google.com/macros/s/AKfycbzNUWjOhh3V-Cu2WYkl6voDKoAHFKjOl_OQbKH6rQYj6o8K06YoQmc0D7Q6WMJJ-Foz/exec";
const EXEC_A = "https://script.google.com/macros/s/AKfycby4camh7UDnlV4ElL3eJPUUWvslSAtfyssAQBRfizcY9D1MRJK9r_O0ZYDnQvKryalG/exec";
const qp=new URLSearchParams(location.search);
const MODE=(qp.get('mode')||'').toLowerCase()==='a'?'a':'b';
const EXEC=MODE==='a'?EXEC_A:EXEC_B;
const tk=qp.get('tk')||''; const problem=qp.get('problem')||'';
if(!tk||!problem){ document.body.innerHTML='<p style="padding:20px">파라미터 누락(tk/problem)</p>'; throw new Error('no params'); }

document.getElementById('meta').textContent=`모드: ${MODE.toUpperCase()} · 문제: ${problem}`;

const v=$('v'), snap=$('snap'), retake=$('retake'), upload=$('upload'), msg=$('msg'), localMatch=$('localMatch');
function $(id){return document.getElementById(id)}
let stream=null, lastBlob=null, lastEmbed=null;

// 카메라 시작
(async ()=>{
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
    v.srcObject=stream;
  }catch(e){ msg.textContent='카메라 권한 필요: '+e.message; }
})();

// 촬영 → blob
snap.onclick=async ()=>{
  const track=stream.getVideoTracks()[0]; const cap=new ImageCapture(track);
  const bitmap=await cap.grabFrame();
  const c=document.createElement('canvas'); c.width=bitmap.width; c.height=bitmap.height;
  const ctx=c.getContext('2d'); ctx.drawImage(bitmap,0,0);
  const data=await new Promise(res=>c.toBlob(b=>res(b),'image/jpeg',0.9));
  lastBlob=data; lastEmbed=null;
  $('f_file').files = await fileListFromBlob(lastBlob,'capture.jpg');
  $('f_ts').value=Date.now();
  snap.style.display='none'; retake.style.display='inline-block'; upload.style.display='inline-block';
  msg.textContent='촬영 완료. 업로드를 눌러 저장하세요.';

  // 임베딩 추출 (A모드 필수 / B모드-로컬매칭 켠 경우)
  if((MODE==='a') || (MODE==='b' && localMatch.checked)){
    try{
      await ensureModels();
      lastEmbed = await extractEmbedFromCanvas(c);
      if(lastEmbed) msg.textContent += ' (임베딩 준비됨)';
    }catch(e){ console.log(e); /* 그냥 넘어감 */ }
  }
};

retake.onclick=()=>{
  lastBlob=null; lastEmbed=null;
  snap.style.display='inline-block'; retake.style.display='none'; upload.style.display='none';
  msg.textContent='';
};

upload.onclick=()=>{
  // child 값(기기 내 매칭이 있으면 alias, 아니면 빈 문자열)
  let childAlias = '';
  if(MODE==='b' && localMatch.checked && lastEmbed){
    childAlias = localMatchOrCreateAlias(lastEmbed); // 기기 내 임시 매칭(서버 저장 없음)
  }
  $('f_key').value=tk;
  $('f_problem').value=problem;
  $('f_child').value=childAlias;
  $('f_embed').value=(MODE==='a' && lastEmbed)? float32ToB64(lastEmbed) : ''; // A모드만 서버 전송
  $('upForm').action = EXEC; // 모드별 EXEC
  $('upForm').submit();
  msg.textContent='업로드 중…(완료 후 대시보드에서 확인)';
  // 초기화
  setTimeout(()=>{ retake.click(); }, 1200);
};

function onUpload(){ return true; }

// Blob을 input[type=file]에 넣기 위한 헬퍼
async function fileListFromBlob(blob, filename){
  const dt=new DataTransfer(); dt.items.add(new File([blob], filename, {type:blob.type}));
  return dt.files;
}

// ====== 임베딩(선택) ======
let modelsReady=false;
async function ensureModels(){
  if(modelsReady) return;
  await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/weights/');
  await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/weights/');
  await faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/weights/');
  modelsReady=true;
}
async function extractEmbedFromCanvas(cnv){
  const det=await faceapi.detectSingleFace(cnv, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
  if(!det||!det.descriptor) return null; // 128D Float32Array
  return det.descriptor;
}
function float32ToB64(arr){
  const buf=new Uint8Array(arr.buffer); // raw bytes
  let binary=''; for(let i=0;i<buf.length;i++) binary+=String.fromCharCode(buf[i]);
  return btoa(binary);
}

// ====== B모드: 기기 내 임시 매칭(IndexedDB 대신 localStorage 간단 구현) ======
function getLocalDB(){
  const raw=localStorage.getItem('faceDB')||'{}'; try{return JSON.parse(raw)}catch(_){return{}}
}
function setLocalDB(db){ localStorage.setItem('faceDB', JSON.stringify(db)) }
function cosine(a,b){
  let dot=0,na=0,nb=0; for(let i=0;i<a.length;i++){ dot+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i]; }
  return dot/(Math.sqrt(na)*Math.sqrt(nb)+1e-9);
}
function localMatchOrCreateAlias(embed){
  let db=getLocalDB(); let bestId='',bestScore=-1;
  Object.keys(db).forEach(id=>{
    const c=db[id]; const s=cosine(embed, new Float32Array(c.vec));
    if(s>bestScore) { bestScore=s; bestId=id; }
  });
  // 임계값(동일인 판정) 예: 0.83
  if(bestScore>=0.83){
    // EMA 업데이트
    const c=db[bestId]; const alpha=0.85;
    const v=new Float32Array(c.vec);
    for(let i=0;i<embed.length;i++) v[i]=alpha*v[i]+(1-alpha)*embed[i];
    db[bestId]={vec:Array.from(v), n:(c.n||1)+1};
    setLocalDB(db);
    return bestId; // alias
  }
  // 새로운 아이(기기 로컬 별칭 생성)
  const alias='아이'+Math.random().toString(36).slice(2,6);
  db[alias]={vec:Array.from(embed), n:1};
  setLocalDB(db);
  return alias;
}
</script>
</body>
</html>
