<!doctype html>
<html lang="ko">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ìº¡ì³ Â· ë¶ˆì˜ ë§ˆë²•ì„ í‘¸ëŠ” ì•ˆì „ ì—´ì‡ </title>
<style>
:root{
  /* í™ˆ/ëŒ€ì‹œë³´ë“œì™€ ë™ì¼ í†¤ */
  --bg-top:#cfe9fb; --bg-bottom:#ffffff; --ink:#0b2a4a;
  --pill:#0d2744; --accent:#22c55e; --line:#d7e7f5;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
  color:var(--ink); background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom));
}
.wrap{max-width:720px;margin:0 auto;padding:16px 14px 28px}
.closeBtn{
  position:fixed; right:14px; top:14px; z-index:10;
  padding:10px 14px; border:0; border-radius:999px; font-weight:900;
  background:#0d2744; color:#fff; box-shadow:0 10px 24px rgba(13,39,68,.25); cursor:pointer;
}
.splash{
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  min-height:calc(100dvh - 60px); text-align:center; gap:16px;
}
.key{width:min(340px,55vw); height:auto; filter:drop-shadow(0 12px 30px rgba(0,0,0,.18))}
h2.big{
  margin:6px 0 0;
  /* ê°¤ëŸ­ì‹œ íƒ­ S ê³„ì—´ 16:10 í™”ë©´ì—ì„œ í•œ í˜ì´ì§€ì— ì•Œë§ë„ë¡ */
  font-size:clamp(40px, 8vw, 96px); 
  line-height:1.05; letter-spacing:-.02em; color:#0b2a4a;
  text-shadow:0 2px 12px rgba(255,255,255,.35);
}
.note{font-size:12px; opacity:.8}

/* ì´¬ì˜ ë‹¨ê³„ UI (ê°€ì… ê¸°ê¸°ì—ì„œë§Œ ë…¸ì¶œ) */
.video{
  width:100%; aspect-ratio:3/4; background:#000; border-radius:14px; overflow:hidden;
  border:1px solid var(--line); box-shadow:0 10px 26px rgba(13,39,68,.15)
}
.row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px}
.btn{
  flex:1; padding:12px 14px; border:0; border-radius:12px; font-weight:900; cursor:pointer;
  background:#274766; color:#fff; box-shadow:0 6px 16px rgba(15,47,87,.18)
}
.btn.secondary{background:#6b7b8c}
.hidden{display:none}
</style>
<body>
  <!-- ìš°ìƒë‹¨ ë‹«ê¸° -->
  <button class="closeBtn" id="btnClose">ë‹«ê¸° âœ•</button>

  <div class="wrap">

    <!-- (1) ìŠ¤í”Œë˜ì‹œ â€“ ê°€ì… ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ ë¨¼ì € ë…¸ì¶œ -->
    <div class="splash" id="splash">
      <img id="keyImg" class="key" alt="ì•ˆì „ ì—´ì‡ ">
      <h2 class="big">ì„±ê³µì…ë‹ˆë‹¤!</h2>
    </div>

    <!-- (2) ì´¬ì˜ UI â€“ ê°€ì… ê¸°ê¸°(tk+problem í™•ì¸)ì—ì„œë§Œ ìë™ ì „í™˜ -->
    <video id="v" class="video hidden" autoplay playsinline muted></video>
    <div class="row hidden" id="btnRow">
      <button id="snap" class="btn">ì´¬ì˜í•˜ê¸°</button>
      <button id="retake" class="btn secondary">ë‹¤ì‹œ ì°ê¸°</button>
      <button id="upload" class="btn">ì—…ë¡œë“œ</button>
    </div>
    <div class="row hidden" id="optRow">
      <label class="note"><input type="checkbox" id="localMatch" checked> ê¸°ê¸° ë‚´ ìë™ë¶„ë¥˜ ë„ì›€(ì €ì¥ X)</label>
    </div>
    <div class="note" id="msg" style="margin-top:6px"></div>

    <!-- ì—…ë¡œë“œ í¼(ìˆ¨ê¹€ iframe) -->
    <form id="upForm" method="post" target="hidden_iframe" enctype="multipart/form-data" onsubmit="return onUpload()" class="hidden">
      <input type="hidden" name="action"  value="uploadSuccess">
      <input type="hidden" name="key"     id="f_key">
      <input type="hidden" name="problem" id="f_problem">
      <input type="hidden" name="child"   id="f_child">
      <input type="hidden" name="ts"      id="f_ts">
      <input type="hidden" name="embed_csv" id="f_embed">
      <input type="file"   name="file"    id="f_file" accept="image/*" capture="user">
    </form>
    <iframe name="hidden_iframe" style="display:none"></iframe>
  </div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<script>
// === ê¸°ê¸° ì´ˆê¸°í™” (?reset=1) ===
const _q=new URLSearchParams(location.search);
if(_q.get('reset')==='1'){
  ['tk','mode','schoolId','classId','faceDB'].forEach(k=>localStorage.removeItem(k));
  location.href = location.origin + location.pathname;
}

// â˜… Apps Script EXEC (A/B)
const EXEC_B="https://script.google.com/macros/s/AKfycbzNUWjOhh3V-Cu2WYkl6voDKoAHFKjOl_OQbKH6rQYj6o8K06YoQmc0D7Q6WMJJ-Foz/exec";
const EXEC_A="https://script.google.com/macros/s/AKfycby4camh7UDnlV4ElL3eJPUUWvslSAtfyssAQBRfizcY9D1MRJK9r_O0ZYDnQvKryalG/exec";

/* ğŸ”‘ ì—¬ê¸°ì— ê¹ƒí—ˆë¸Œì— ì˜¬ë¦° fire-key íŒŒì¼ ì£¼ì†Œë¥¼ ë„£ìœ¼ì„¸ìš”.
   ì˜ˆ: https://seol-glitter.github.io/teachercapture/fire-key.png */
const KEY_IMG_URL="https://seol-glitter.github.io/teachercapture/fire-key.png";

/* íŒŒë¼ë¯¸í„° & ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í´ë°± */
const qs=new URLSearchParams(location.search);
const problem=(qs.get('problem')||'').trim();
const tk=((qs.get('tk')||localStorage.getItem('tk')||'').trim());
const MODE=((qs.get('mode')||localStorage.getItem('mode')||'b').trim().toLowerCase()==='a')?'a':'b';
const EXEC=MODE==='a'?EXEC_A:EXEC_B;

/* ìŠ¤í”Œë˜ì‹œì— ì—´ì‡  ì´ë¯¸ì§€ ì£¼ì… */
const keyEl=document.getElementById('keyImg');
keyEl.src = KEY_IMG_URL || 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><defs><linearGradient id="g" x1="0" x2="0" y1="0" y2="1"><stop stop-color="#ffcc33"/><stop offset="1" stop-color="#ff8514"/></linearGradient></defs><path d="M128 0c40 30 64 63 64 102 0 31-16 55-43 73-9 6-11 19-4 28l10 13c29 36 29 75 1 112-22 29-57 45-95 45-29 0-52-9-61-14 42-18 69-46 80-85 5-18 5-37-2-56-5-14-3-30 7-41 17-20 26-38 26-57C111 74 116 48 128 0z" fill="#ff5a17"/><rect x="110" y="320" width="36" height="150" rx="8" fill="url(#g)"/><rect x="146" y="380" width="46" height="36" rx="5" fill="#111"/><rect x="146" y="430" width="46" height="36" rx="5" fill="#111"/></svg>`);

/* ë‹«ê¸° ë²„íŠ¼ */
document.getElementById('btnClose').onclick=()=>{ window.close(); };

/* tkì™€ problemì´ ìˆìœ¼ë©´ 1.4ì´ˆ ë’¤ ì´¬ì˜ ë‹¨ê³„ë¡œ ì „í™˜ */
if(tk && problem){ setTimeout(startCameraFlow, 1400); }

const v=$('v'), snap=$('snap'), retake=$('retake'), upload=$('upload'), msg=$('msg'), localMatch=$('localMatch');
const btnRow=$('btnRow'), optRow=$('optRow'), splash=$('splash'), upForm=$('upForm');
let stream=null, lastBlob=null, lastEmbed=null;
function $(id){return document.getElementById(id)}
function showCaptureUI(show){
  if(show){ v.classList.remove('hidden'); btnRow.classList.remove('hidden'); optRow.classList.remove('hidden'); upForm.classList.remove('hidden'); splash.classList.add('hidden'); }
  else{ v.classList.add('hidden'); btnRow.classList.add('hidden'); optRow.classList.add('hidden'); upForm.classList.add('hidden'); splash.classList.remove('hidden'); }
}

async function startCameraFlow(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false});
    v.srcObject=stream;
    showCaptureUI(true);
    snap.style.display='inline-block'; retake.style.display='none'; upload.style.display='none';
  }catch(e){
    msg.textContent='ì¹´ë©”ë¼ ê¶Œí•œ í•„ìš”: '+e.message;
  }
}

snap.onclick=async ()=>{
  try{
    const c=document.createElement('canvas'); const ctx=c.getContext('2d');
    if('ImageCapture' in window && stream?.getVideoTracks?.()[0]){
      const cap=new ImageCapture(stream.getVideoTracks()[0]); const bitmap=await cap.grabFrame();
      c.width=bitmap.width; c.height=bitmap.height; ctx.drawImage(bitmap,0,0);
    }else{
      c.width = v.videoWidth || 720; c.height = v.videoHeight || Math.round(c.width*4/3);
      ctx.drawImage(v,0,0,c.width,c.height);
    }
    const blob = await new Promise(res=>c.toBlob(b=>res(b),'image/jpeg',0.9));
    lastBlob=blob; lastEmbed=null;
    $('f_file').files = await fileListFromBlob(lastBlob,'capture.jpg');
    $('f_ts').value = Date.now();

    // A/B ëª¨ë“œë³„ ì„ë² ë”© ì¤€ë¹„
    if((MODE==='a') || (MODE==='b' && localMatch.checked)){
      try{
        await ensureModels();
        const det=await faceapi.detectSingleFace(c,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        if(det && det.descriptor){ lastEmbed=det.descriptor; }
      }catch(e){}
    }

    snap.style.display='none'; retake.style.display='inline-block'; upload.style.display='inline-block';
    msg.textContent='ì´¬ì˜ ì™„ë£Œ. ì—…ë¡œë“œë¥¼ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”.';
  }catch(e){ msg.textContent='ì´¬ì˜ ì˜¤ë¥˜: '+e.message; }
};
retake.onclick=()=>{ lastBlob=null; lastEmbed=null; snap.style.display='inline-block'; retake.style.display='none'; upload.style.display='none'; msg.textContent=''; };
upload.onclick=()=>{
  let childAlias='';
  if(MODE==='b' && localMatch.checked && lastEmbed){ childAlias=localMatchOrCreateAlias(lastEmbed); }
  $('f_key').value     = tk;
  $('f_problem').value = problem;
  $('f_child').value   = childAlias;
  $('f_embed').value   = (MODE==='a' && lastEmbed) ? Array.from(lastEmbed).join(',') : '';
  upForm.action        = (MODE==='a'?EXEC_A:EXEC_B);
  upForm.submit();
  msg.textContent='ì—…ë¡œë“œ ì¤‘â€¦ ì™„ë£Œ í›„ ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”.';
  setTimeout(()=>{ retake.click(); }, 1200);
};

function onUpload(){ return true; }
async function fileListFromBlob(blob, filename){
  const dt=new DataTransfer(); dt.items.add(new File([blob], filename, {type:blob.type})); return dt.files;
}

/* face-api + ë¡œì»¬ ì„ì‹œë§¤ì¹­(B) */
let modelsReady=false;
async function ensureModels(){
  if(modelsReady) return;
  const base='https://cdn.jsdelivr.net/npm/face-api.js/weights/';
  await faceapi.nets.tinyFaceDetector.loadFromUri(base);
  await faceapi.nets.faceLandmark68Net.loadFromUri(base);
  await faceapi.nets.faceRecognitionNet.loadFromUri(base);
  modelsReady=true;
}
function cosine(a,b){let dot=0,na=0,nb=0;for(let i=0;i<a.length;i++){dot+=a[i]*b[i];na+=a[i]*a[i];nb+=b[i]*b[i]}return dot/(Math.sqrt(na)*Math.sqrt(nb)+1e-9)}
function getLocalDB(){ try{return JSON.parse(localStorage.getItem('faceDB')||'{}')}catch(_){return{}} }
function setLocalDB(db){ localStorage.setItem('faceDB', JSON.stringify(db)) }
function localMatchOrCreateAlias(embed){
  let db=getLocalDB(); let bestId='',bestScore=-1;
  Object.keys(db).forEach(id=>{const c=db[id]; const s=cosine(embed,new Float32Array(c.vec)); if(s>bestScore){bestScore=s;bestId=id;}});
  if(bestScore>=0.83){
    const c=db[bestId], alpha=0.85, v=new Float32Array(c.vec);
    for(let i=0;i<embed.length;i++) v[i]=alpha*v[i]+(1-alpha)*embed[i];
    db[bestId]={vec:Array.from(v),n:(c.n||1)+1}; setLocalDB(db); return bestId;
  }
  const alias='ì•„ì´'+Math.random().toString(36).slice(2,6);
  db[alias]={vec:Array.from(embed),n:1}; setLocalDB(db); return alias;
}
</script>
</body>
</html>
